@model Orderaty.Models.Seller
@using Orderaty.ViewModels
@{
    // NULL CHECK: Use ?.FullName and provide a fallback title
    ViewData["Title"] = $"Store Profile - {Model.User?.FullName ?? "Details"}";
    var hasReviewed = ViewBag.HasReviewed as bool? ?? false;
    var existingReview = ViewBag.ExistingReview as Orderaty.Models.SellerReview;
}

<link rel="stylesheet" href="~/css/store-details.css">

<style>
    /* Toast Notification Styles */
    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        z-index: 9999;
        min-width: 350px;
        max-width: 450px;
        animation: slideInRight 0.4s ease-out;
    }

    .toast-notification i {
        font-size: 1.75rem;
        flex-shrink: 0;
    }

    .toast-notification .message-content {
        flex: 1;
    }

    .toast-notification .message-title {
        font-weight: 700;
        font-size: 1.05rem;
        margin-bottom: 0.35rem;
    }

    .toast-notification .message-text {
        font-size: 0.9rem;
        opacity: 0.95;
        line-height: 1.4;
    }

    .toast-notification .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
    }

    .toast-notification .close-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .toast-notification.fade-out {
        animation: fadeOut 0.3s ease-out forwards;
    }

    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    @@media (max-width: 768px) {
        .toast-notification {
            top: 10px;
            right: 10px;
            left: 10px;
            min-width: auto;
            max-width: none;
        }
    }
</style>

<div id="store-profile-page-container">
    <div class="page-wrapper pb-20 md:pb-8">

        <div class="container">
            <div class="store-info-header-wrapper">
                <div class="store-info-card card">
                    <div class="card-content p-6">
                        <div class="store-header-layout">
                            <div class="store-logo-wrapper">
                                <img id="store-logo" src="~/images/users/@Model.User?.Image" alt="@(Model.User?.FullName ?? "Store") logo" class="store-logo image-with-fallback"
                                     onerror="this.onerror=null; this.src='/images/default-user.png';">
                            </div>
                            <div class="store-details">
                                <div class="store-title-badge-wrapper">
                                    <div>
                                        <h1 id="store-name" class="store-title">@(Model.User?.FullName ?? "Store Name")</h1>
                                        <span id="store-category-badge" class="badge">@Model.Category.ToString().Replace("_", " ")</span>
                                        <span class="badge" style="background-color: @(Model.Status == SellerStatus.Open ? "var(--primary)" : "var(--muted-foreground)"); color: white;">@Model.Status.ToString().Replace("_", " ")</span>
                                    </div>
                                </div>
                                <div class="store-meta-info">
                                    <div class="store-meta-item">
                                        <svg class="icon icon-sm star-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></svg>
                                        <span id="store-rating-reviews">@Model.Rating.ToString("F1") (@(Model.SellerReviews?.Count ?? 0) reviews)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="separator my-6" />
                        <div class="store-contact-grid">
                            <div class="contact-item">
                                <svg class="icon icon-md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></svg>
                                <div>
                                    <p class="contact-item-label">Address</p>
                                    <p id="store-address" class="contact-item-value">@Model.Address</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tabs-container mb-8">
                <div class="tabs-list mb-6">
                    <button id="tab-products" class="tab-trigger active" data-tab-target="#content-products">Products</button>
                    <button id="tab-reviews" class="tab-trigger" data-tab-target="#content-reviews">Reviews</button>
                </div>

                <div id="content-products" class="tab-content active">
                    <div id="products-grid-container" class="products-grid">
                        @if (Model.Products == null || !Model.Products.Any())
                        {
                            <p class="text-muted-foreground text-center">No products found for this seller.</p>
                        }
                        else
                        {
                            @foreach (var product in Model.Products)
                            {
                                <a href="/ClientProduct/Details/@product.Id" class="card product-card" style="text-decoration: none; color: inherit;">
                                    <div class="card-image-container">
                                        <img src="~/images/products/@product.Image" alt="@product.Name" class="card-image image-with-fallback"
                                             onerror="this.onerror=null; this.src='/images/default-product.png';">
                                    </div>
                                    <div class="card-content p-4">
                                        <h3 class="card-title mb-2">@product.Name</h3>
                                        <div class="product-info-flex">
                                            <div>
                                                <p class="product-price">@product.Price.ToString("N2") EGP</p>
                                            </div>
                                            <button class="add-to-cart-button" aria-label="Add @product.Name to cart">
                                                <svg class="icon icon-md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19" /><line x1="5" x2="19" y1="12" y2="12" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                </a>
                            }
                        }
                    </div>
                </div>

                <div id="content-reviews" class="tab-content hidden">
                    @if (User.Identity.IsAuthenticated && User.IsInRole("Client"))
                    {
                        <div class="review-form-card card">
                            <div class="card-content">
                                <h3 class="review-form-title">@(hasReviewed ? "Update Your Review" : "Write a Review")</h3>
                                <form asp-action="CreateReview" asp-controller="Seller" method="post" id="review-form">
                                    <input type="hidden" name="SellerId" value="@Model.Id" />
                                    
                                    <div class="rating-input-container">
                                        <label class="rating-label">Rating <span style="color: var(--error-color);">*</span></label>
                                        <div class="rating-input">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <button type="button" class="star-button" data-rating="@i" aria-label="Rate @i stars">
                                                    <svg class="icon star-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                                    </svg>
                                                </button>
                                            }
                                        </div>
                                        <input type="hidden" name="Rating" id="rating-input" value="@(existingReview?.Rating ?? 0)" required />
                                        <span id="rating-error" class="rating-error" style="display: none;">Please select a rating</span>
                                    </div>

                                    <div class="comment-input-container">
                                        <label for="Comment" class="comment-label">Comment <span style="color: var(--text-secondary); font-weight: 400;">(Optional)</span></label>
                                        <textarea name="Comment" id="Comment" class="comment-textarea" rows="4" placeholder="Share your experience with this store... What did you like? What could be improved?" maxlength="500">@(existingReview?.Comment ?? "")</textarea>
                                        <small class="comment-hint">Maximum 500 characters</small>
                                    </div>

                                    <button type="submit" class="review-submit-button">
                                        <svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        @(hasReviewed ? "Update Review" : "Submit Review")
                                    </button>
                                </form>
                            </div>
                        </div>
                    }

                    <div class="reviews-section-header">
                        <h2 class="reviews-section-title">Customer Reviews (@(Model.SellerReviews?.Count ?? 0))</h2>
                    </div>

                    <div id="reviews-list-container" class="reviews-list">
                        @if (Model.SellerReviews == null || !Model.SellerReviews.Any())
                        {
                            <div class="no-reviews-message">
                                <p style="font-size: 1.125rem; margin-bottom: 0.5rem; color: var(--text-primary); font-weight: 600;">No reviews yet</p>
                                <p style="margin: 0;">@(User.Identity.IsAuthenticated && User.IsInRole("Client") ? "Be the first to share your experience with this store!" : "This store hasn't received any reviews yet.")</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var review in Model.SellerReviews.OrderByDescending(r => r.Id))
                            {
                                var authorName = review.Client?.User?.FullName ?? "Anonymous";
                                var initials = !string.IsNullOrEmpty(authorName) && authorName != "Anonymous" 
                                    ? string.Join("", authorName.Split(' ').Take(2).Select(n => n[0])).ToUpper()
                                    : "?";
                                
                                <div class="review-card card">
                                    <div class="card-content">
                                        <div class="review-header">
                                            <div class="review-author-section">
                                                <div class="review-author-avatar">
                                                    @initials
                                                </div>
                                                <div class="review-author-info">
                                                    <h4 class="review-author">@authorName</h4>
                                                    <span class="review-date">Verified Customer</span>
                                                </div>
                                            </div>
                                            <div class="review-rating">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    @if (i <= review.Rating)
                                                    {
                                                        <svg class="icon star-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                                        </svg>
                                                    }
                                                    else
                                                    {
                                                        <svg class="icon" style="color: #d1d5db;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                                        </svg>
                                                    }
                                                }
                                                <span class="review-rating-value">@review.Rating.ToString("F1")</span>
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(review.Comment))
                                        {
                                            <p class="review-comment">@review.Comment</p>
                                        }
                                        else
                                        {
                                            <p class="review-comment" style="font-style: italic; color: var(--text-secondary);">No comment provided.</p>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Function to set up tab switching logic
        function setupTabs() {
            const tabTriggers = document.querySelectorAll('.tab-trigger');
            const tabContents = document.querySelectorAll('.tab-content');

            tabTriggers.forEach(trigger => {
                trigger.addEventListener('click', () => {
                    const targetSelector = trigger.getAttribute('data-tab-target');
                    const targetContent = document.querySelector(targetSelector);

                    // Deactivate all triggers
                    tabTriggers.forEach(t => t.classList.remove('active'));
                    // Activate the clicked trigger
                    trigger.classList.add('active');

                    // Hide all content panels
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.classList.add('hidden');
                    });

                    // Show the target content panel
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        targetContent.classList.add('active');
                    }
                });
            });

            // Trigger a click on the initial active tab to ensure correct state on load
            const initialActiveTab = document.querySelector('.tab-trigger.active');
            if (initialActiveTab) {
                initialActiveTab.click();
            }
        }

        // Initialize the tab logic
        setupTabs();

        // Rating star selection
        const starButtons = document.querySelectorAll('.star-button');
        const ratingInput = document.getElementById('rating-input');
        const ratingError = document.getElementById('rating-error');
        const existingRating = @(existingReview?.Rating ?? 0);

        // Initialize all stars as empty first
        function initializeStars() {
            starButtons.forEach((button) => {
                const starIcon = button.querySelector('svg');
                starIcon.setAttribute('fill', 'none');
                starIcon.style.fill = 'none';
                starIcon.style.color = '#d1d5db';
                starIcon.classList.remove('filled');
                starIcon.classList.add('empty');
            });
        }

        // Initialize stars on page load
        initializeStars();

        // Update stars based on rating
        function updateStars(rating) {
            starButtons.forEach((button, index) => {
                const starIcon = button.querySelector('svg');
                if (index < rating) {
                    // Fill the star
                    starIcon.setAttribute('fill', 'currentColor');
                    starIcon.style.fill = 'currentColor';
                    starIcon.style.color = '#fbbf24';
                    starIcon.classList.remove('empty');
                    starIcon.classList.add('filled');
                } else {
                    // Empty star
                    starIcon.setAttribute('fill', 'none');
                    starIcon.style.fill = 'none';
                    starIcon.style.color = '#d1d5db';
                    starIcon.classList.remove('filled');
                    starIcon.classList.add('empty');
                }
            });
        }

        // Initialize stars based on existing rating if available
        if (existingRating > 0) {
            ratingInput.value = existingRating;
            updateStars(existingRating);
        } else {
            ratingInput.value = 0;
        }

        starButtons.forEach((button, index) => {
            button.addEventListener('click', () => {
                const rating = index + 1;
                ratingInput.value = rating;
                updateStars(rating);
                if (ratingError) {
                    ratingError.style.display = 'none';
                }
            });

            button.addEventListener('mouseenter', () => {
                const rating = index + 1;
                updateStars(rating);
            });
        });

        // Reset stars on mouse leave to show current selection
        const ratingContainer = document.querySelector('.rating-input');
        if (ratingContainer) {
            ratingContainer.addEventListener('mouseleave', () => {
                const currentRating = parseInt(ratingInput.value) || 0;
                updateStars(currentRating);
            });
        }

        // Form validation
        const reviewForm = document.getElementById('review-form');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                const rating = parseInt(ratingInput.value) || 0;
                if (rating < 1 || rating > 5) {
                    e.preventDefault();
                    if (ratingError) {
                        ratingError.style.display = 'block';
                    }
                    return false;
                }
            });
        }

        // Toast notification functions
        function showToast(message, type = 'success') {
            // Remove any existing toast
            const existingToast = document.getElementById('reviewToast');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.id = 'reviewToast';
            
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const bgColor = type === 'success' 
                ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' 
                : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            
            toast.style.background = bgColor;
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <div class="message-content">
                    <div class="message-title">${type === 'success' ? 'Success!' : 'Error!'}</div>
                    <div class="message-text">${message}</div>
                </div>
                <button class="close-btn" onclick="closeReviewToast()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            // Add toast to body
            document.body.appendChild(toast);

            // Auto-dismiss after 5 seconds
            setTimeout(function() {
                closeReviewToast();
            }, 5000);
        }

        function closeReviewToast() {
            const toast = document.getElementById('reviewToast');
            if (toast) {
                toast.classList.add('fade-out');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }
        }

        // Show success/error messages from TempData
        @if (TempData["Success"] != null)
        {
            <text>
            setTimeout(function() {
                showToast('@Html.Raw(TempData["Success"])', 'success');
            }, 300);
            </text>
        }
        @if (TempData["Error"] != null)
        {
            <text>
            setTimeout(function() {
                showToast('@Html.Raw(TempData["Error"])', 'error');
            }, 300);
            </text>
        }
    </script>
}